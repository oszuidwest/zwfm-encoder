<!DOCTYPE html>
<html lang="en">
<!--
  ZuidWest FM Encoder - Web Interface

  Single-page application for real-time audio monitoring and encoder control.
  Built with Alpine.js for reactive state management.

  Views:
    - Dashboard: Live VU meter, encoder status, stream/recorder management
    - Settings: Audio input, silence detection, notifications, about info
    - Stream Form: Add/edit streams
    - Recorder Form: Add/edit audio recorders

  State Management:
    - Alpine.js component: encoderApp() defined in app.js
    - View switching via 'view' property
    - WebSocket at /ws for real-time updates

  File Dependencies:
    - style.css: All styling and animations
    - icons.js: SVG icon definitions (window.icons)
    - app.js: Alpine.js application logic
    - alpine.js: Alpine.js framework

  @see app.js for state management and WebSocket handling
  @see style.css for component styling
  @see icons.js for SVG icon reference
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="description" content="{{.StationName}} - Audio Encoder">
    <title>{{.StationName}}</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="canonical" href="/">
    <link rel="stylesheet" href="/style.css">
    <style>{{.PrimaryCSS}}</style>
    <script src="/alpine.min.js" defer="defer"></script>
</head>
<body x-data="encoderApp">
    <!-- Connection overlay - blocks UI when WebSocket disconnected -->
    <div class="connection-overlay" x-show="encoder.state === 'connecting'" x-cloak>
        <div class="content">
            <div class="loading">Connecting...</div>
        </div>
    </div>

    <!-- Alert banner - page-wide header for silence/update notifications -->
    <div class="alert-banner"
         role="alert"
         aria-live="assertive"
         x-show="banner.visible"
         x-transition:enter.duration.200ms
         x-transition:leave.duration.150ms
         :data-variant="banner.type"
         x-cloak>
        <span class="message" x-text="banner.message"></span>
    </div>

    <!-- FFmpeg not available banner - persistent, non-dismissable -->
    <div class="alert-banner"
         data-variant="danger"
         role="alert"
         aria-live="assertive"
         x-show="!ffmpegAvailable"
         x-transition:enter.duration.200ms
         x-transition:leave.duration.150ms
         x-cloak>
        <span class="message">FFmpeg not found. Install FFmpeg and restart the application.</span>
    </div>

    <!-- Toast notifications - transient feedback for user actions -->
    <div class="toast-container" aria-live="polite" x-cloak>
        <template x-for="toast in toasts" :key="toast.id">
            <div class="toast"
                 :data-type="toast.type"
                 x-transition:enter="toast-enter"
                 x-transition:leave="toast-leave">
                <span class="toast-icon" x-html="toast.type === 'success' ? icons.check : toast.type === 'error' ? icons.warning : icons.info"></span>
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>

    <main class="container">
        <noscript>
            <p class="noscript-message">This application requires JavaScript to function.</p>
        </noscript>

        <!-- === Dashboard View ===
             Main monitoring interface showing:
             - Header with settings and logout buttons
             - Audio input device selector
             - VU meter with real-time levels
             - Source status alerts
             - Stream list with individual status indicators -->
        <div id="dashboard-view" x-show="view === 'dashboard'" x-transition:enter.duration.200ms x-cloak>
            <header class="app-header">
                <div class="brand">
                    <span class="logo" x-html="icons.appLogo"></span>
                    <h1 class="title">{{.StationName}}</h1>
                </div>
                <div class="actions">
                    <button class="icon-btn" type="button" tabindex="0" title="Settings" aria-label="Settings" @click="showSettings()">
                        <span class="icon-container" x-html="icons.settings"></span>
                    </button>
                    <a class="icon-btn" href="/logout" tabindex="0" title="Sign out" aria-label="Sign out">
                        <span class="icon-container" x-html="icons.logout"></span>
                    </a>
                </div>
            </header>

            <div class="banner" x-show="version.update_available && version.latest" x-cloak>
            <span class="icon-container" x-html="icons.cloud"></span>
            <span>Update available: <strong x-text="version.latest"></strong></span>
            <a rel="noopener" href="https://github.com/oszuidwest/zwfm-encoder/releases" title="View release on GitHub" target="_blank">View release</a>
        </div>

        <section class="card">
            <div class="header" data-theme="brand">
                <h2>Audio Source</h2>
                <span class="badge">Input</span>
            </div>
            <div class="body">
                <div class="form">
                    <div class="group">
                        <label for="audio-input">Input Device</label>
                        <select id="audio-input" x-model="config.audio_input" @focus="refreshDevices()" @change="updateAudioInput()">
                            <template x-if="devices.length === 0">
                                <option value="">No devices found</option>
                            </template>
                            <template x-if="devices.length > 0 && !config.audio_input">
                                <option value="" disabled selected>Select audio input...</option>
                            </template>
                            <template x-for="device in devices" :key="device.id">
                                <option :value="device.id" x-text="device.name"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <!-- === VU Meter Component ===
                     Real-time audio level visualization with:
                     - Mode toggle: Peak (default) vs RMS display
                     - Silence indicator: Activates when audio below threshold for configured duration
                     - Clip indicator: Flashes when levels exceed 0dB, held for 1.5s
                     - Two channels (L/R): Gradient bar with peak hold marker
                     - Scale: Reference marks at -60, -48, -24, -12, -6, 0 dB
                     Updates ~4 times per second -->
                <div class="vu">
                    <div class="meter-header">
                        <button class="mode-btn" type="button" tabindex="0" @click="toggleVuMode()" x-text="vuMode === 'peak' ? 'Peak' : 'RMS'"></button>
                        <!-- Status indicators - visual feedback for audio state
                             Silence: Yellow dot when audio below threshold
                             Clip: Red flash when audio exceeds 0dB -->
                        <div class="indicators">
                            <span class="indicator" aria-label="Silence indicator"><span class="dot" :class="getSilenceStateClass()"></span>Silence</span>
                            <span class="indicator" aria-label="Clip indicator"><span class="dot" :class="getClipStateClass()"></span>Clip</span>
                        </div>
                    </div>
                    <template x-for="ch in vuChannels" :key="ch.label">
                        <div class="channel">
                            <span class="label" x-text="ch.label"></span>
                            <div class="track-wrapper">
                                <div class="track">
                                    <div class="gradient"></div>
                                    <div class="cover" :style="{ width: `${100 - dbToPercent(vuMode === 'peak' ? levels[ch.display] : levels[ch.level])}%` }"></div>
                                </div>
                                <div class="peak" :style="{ left: `${dbToPercent(levels[ch.hold])}%` }" :data-visible="vuMode === 'peak' && levels[ch.hold] > -59 ? true : null"></div>
                            </div>
                            <span class="db" x-text="`${(vuMode === 'peak' ? levels[ch.hold] : levels[ch.level]).toFixed(1)} dB`"></span>
                        </div>
                    </template>
                    <div class="scale">
                        <span class="mark" data-db="-60">-60</span>
                        <span class="mark" data-db="-48">-48</span>
                        <span class="mark" data-db="-24">-24</span>
                        <span class="mark" data-db="-12">-12</span>
                        <span class="mark" data-db="-6">-6</span>
                        <span class="mark" data-db="0">0</span>
                    </div>
                </div>

                <!-- Source status alert - shows when audio capture has issues
                     Conditions:
                     - No audio input device selected
                     - Source process not running
                     - Last error from source capture
                     Displays retry counter when encoder is attempting recovery -->
                <div class="alert" role="alert" x-show="hasSourceIssue" x-cloak>
                    <span class="icon-container" x-html="icons.warning"></span>
                    <div>
                        <span x-text="encoder.sourceRetryCount > 0 ? `Retry ${encoder.sourceRetryCount}/${encoder.sourceMaxRetries}` : 'Error'"></span>
                        <p x-show="encoder.lastError" x-text="encoder.lastError"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- === Streams List ===
             Displays configured streams with real-time status.

             Each stream shows:
             - Status dot (color-coded by state)
             - Host:port and stream ID
             - Status text (Connected, Connecting, Retry N/M, Failed)
             - Error message when in failed state
             - Delete button (disabled while deletion in progress)

             Status states:
             - Green: Connected and streaming
             - Yellow: Connecting or retrying
             - Red: Failed (shows error)
             - Gray: Encoder not running -->
        <section class="card">
            <div class="header" data-theme="slate">
                <h2>Streams</h2>
                <div class="actions">
                    <span class="badge" x-text="streams.length"></span>
                    <button class="add-btn" type="button" tabindex="0" aria-label="Add stream"
                                            :disabled="!ffmpegAvailable"
                                            :title="!ffmpegAvailable ? 'FFmpeg not available' : ''"
                                            @click="showStreamForm()">
                        <span class="icon-container" x-html="icons.plus"></span>
                        Add
                    </button>
                </div>
            </div>
            <div class="body">
                <div class="outputs">
                    <template x-if="streams.length === 0">
                        <div class="empty-state">No streams configured</div>
                    </template>
                    <template x-for="stream in streams" :key="stream.id">
                        <div class="item"
                             x-data="{ get d() { return getStreamDisplayData(stream) } }"
                             :data-deleting="deletingStreams[stream.id] === stream.created_at ? true : null">
                            <div class="row">
                                <span class="dot" :class="d.stateClass" :data-connected="connectingAnimations[stream.id] ? 'true' : null"></span>
                                <span class="host" x-text="`${stream.host}:${stream.port}`"></span>
                                <button class="icon-btn" data-variant="edit" type="button" tabindex="0" title="Edit" aria-label="Edit stream"
                                        @click="showStreamForm(stream.id)">
                                    <span class="icon-container" x-html="icons.edit"></span>
                                </button>
                            </div>
                            <div class="details">
                                <span class="codec" x-text="stream.codec.toUpperCase()"></span>
                                <span class="streamid" x-text="`#${stream.stream_id}`"></span>
                                <span class="status" :class="d.stateClass" x-text="d.statusText"></span>
                            </div>
                            <div class="alert" role="alert" x-show="d.showError">
                                <span class="icon-container" x-html="icons.warning"></span>
                                <span x-text="d.lastError"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- === Recorders List ===
             Displays configured recorders with real-time status.
             Each recorder shows:
             - Status dot (color-coded by state)
             - Name and rotation mode
             - Status text (Recording, Idle, Disabled)
             Click to edit, + button to add new -->
        <section class="card">
            <div class="header" data-theme="slate">
                <h2>Recorders</h2>
                <div class="actions">
                    <span class="badge" x-text="recorders.length" x-show="recorders.length > 0"></span>
                    <button class="add-btn" type="button" tabindex="0" aria-label="Add recorder"
                            :disabled="!ffmpegAvailable"
                            :title="!ffmpegAvailable ? 'FFmpeg not available' : ''"
                            @click="showRecorderForm()">
                        <span class="icon-container" x-html="icons.plus"></span>
                        Add
                    </button>
                </div>
            </div>
            <div class="body">
                <div class="outputs">
                    <template x-if="recorders.length === 0">
                        <div class="empty-state">No recorders configured</div>
                    </template>
                    <template x-for="recorder in recorders" :key="recorder.id">
                        <div class="item"
                             x-data="{ get d() { return getRecorderDisplayData(recorder) } }"
                             :data-deleting="deletingRecorders[recorder.id] === recorder.created_at ? true : null">
                            <div class="row">
                                <span class="dot" :class="d.stateClass"></span>
                                <span class="host" x-text="recorder.name"></span>
                                <button class="icon-btn" data-variant="edit" type="button" tabindex="0" title="Edit" aria-label="Edit recorder"
                                        @click="showRecorderForm(recorder.id)">
                                    <span class="icon-container" x-html="icons.edit"></span>
                                </button>
                            </div>
                            <div class="details">
                                <span class="codec" x-text="recorder.codec.toUpperCase()"></span>
                                <span class="streamid" x-text="recorder.rotation_mode === 'hourly' ? 'Hourly' : 'On-Demand'"></span>
                                <span class="status" :class="d.stateClass" x-text="d.statusText"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        </div>

        <!-- === Settings View ===
             Configuration interface with tabbed navigation.

             Tabs: Audio | Notifications | Events | About

             Cancel/Save workflow:
             - Cancel restores original values, Save persists all changes
             - Test buttons disabled when unsaved changes exist
             - Settings not overwritten by status updates while editing -->
        <div id="settings-view" class="settings" x-show="view === 'settings'" x-transition:enter.duration.200ms x-cloak>
            <header class="nav">
                <button class="nav-btn" type="button" tabindex="0" @click="cancelSettings()" :disabled="saving">Cancel</button>
                <h2>Settings</h2>
                <button class="nav-btn" data-variant="save" type="button" tabindex="0" @click="saveSettings()" :disabled="!settingsDirty || saving" x-text="saving ? 'Saving...' : 'Save'">Save</button>
            </header>

            <!-- Settings tab navigation - segmented control style
                 Tab switching is UI-only (no persistence)
                 Sliding indicator animates between tabs -->
            <div class="tabs" role="tablist">
                <template x-for="tab in settingsTabs" :key="tab.id">
                    <button class="tab" type="button" role="tab" :id="'tab-' + tab.id" :aria-selected="settingsTab === tab.id" :aria-controls="'panel-' + tab.id" :tabindex="settingsTab === tab.id ? 0 : -1" :title="tab.label" @click="showTab(tab.id)">
                        <span class="icon-container" x-html="icons[tab.icon]"></span>
                        <span class="label" x-text="tab.label"></span>
                    </button>
                </template>
            </div>

            <div class="panels">
                <!-- Audio Panel - Silence detection configuration
                     - Threshold: dB level below which audio is considered silent (-60 to 0)
                     - Duration: Seconds of silence before triggering alerts (1-3600)
                     - Recovery: Seconds of audio before clearing silence state (1-60) -->
                <div class="panel" role="tabpanel" id="panel-audio" aria-labelledby="tab-audio" x-show="settingsTab === 'audio'">
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.audio"></span>
                            <h3>Silence Detection</h3>
                        </div>
                        <p class="section-desc">Alert when audio drops below threshold for extended periods.</p>
                        <div class="form">
                            <div class="group">
                                <label for="silence-threshold">Threshold</label>
                                <div class="input-group">
                                    <input id="silence-threshold" type="number" max="0" min="-60" step="1" x-model.number="settingsForm.silenceThreshold" @input="markSettingsDirty()" aria-describedby="silence-threshold-hint">
                                    <span class="input-unit">dB</span>
                                </div>
                                <span id="silence-threshold-hint" class="input-hint">Audio below this level is considered silence.</span>
                            </div>
                            <div class="row">
                                <div class="group">
                                    <label for="silence-duration">Silence Duration</label>
                                    <div class="input-group">
                                        <input id="silence-duration" type="number" max="300" min="0.5" step="0.5" x-model.number="settingsForm.silenceDuration" @input="markSettingsDirty()" aria-describedby="silence-duration-hint">
                                        <span class="input-unit">sec</span>
                                    </div>
                                </div>
                                <div class="group">
                                    <label for="silence-recovery">Recovery Time</label>
                                    <div class="input-group">
                                        <input id="silence-recovery" type="number" max="60" min="0.5" step="0.5" x-model.number="settingsForm.silenceRecovery" @input="markSettingsDirty()" aria-describedby="silence-duration-hint">
                                        <span class="input-unit">sec</span>
                                    </div>
                                </div>
                            </div>
                            <span id="silence-duration-hint" class="input-hint">Silence triggers alerts. Recovery clears after audio returns.</span>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.file"></span>
                            <h3>Silence Dumps</h3>
                        </div>
                        <p class="section-desc">Capture MP3 snippets around silence events. These are attached to email notifications and included in webhooks.</p>
                        <div class="form">
                            <div class="group">
                                <label>Capture</label>
                                <div class="segmented segmented--neutral">
                                    <button type="button" class="segmented-btn" :aria-pressed="(!settingsForm.silenceDump.enabled).toString()" @click="settingsForm.silenceDump.enabled = false; markSettingsDirty()">Disabled</button>
                                    <button type="button" class="segmented-btn" :aria-pressed="settingsForm.silenceDump.enabled.toString()" @click="settingsForm.silenceDump.enabled = true; markSettingsDirty()">Enabled</button>
                                </div>
                            </div>
                            <div class="group" x-show="settingsForm.silenceDump.enabled">
                                <label for="dump-retention">Retention</label>
                                <div class="input-group">
                                    <input id="dump-retention" type="number" min="1" max="365" step="1" x-model.number="settingsForm.silenceDump.retentionDays" @input="markSettingsDirty()">
                                    <span class="input-unit">days</span>
                                </div>
                                <span class="input-hint">Files older than this are automatically cleaned up daily.</span>
                            </div>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.key"></span>
                            <h3>Recording API</h3>
                        </div>
                        <p class="section-desc">Authentication key for external recording control (POST /api/recordings/start, /api/recordings/stop).</p>
                        <div class="form">
                            <div class="group">
                                <label for="api-key">API Key</label>
                                <input id="api-key" type="text" readonly
                                       :value="settingsForm?.recordingApiKey ? settingsForm.recordingApiKey : 'Not configured'"
                                       :class="{ 'font-mono': settingsForm?.recordingApiKey }">
                                <span class="input-hint" x-show="!settingsForm?.recordingApiKey">No API key configured. Click Regenerate to create one.</span>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn" data-variant="secondary" data-size="test" type="button" tabindex="0"
                                    @click="copyApiKey()"
                                    :disabled="!settingsForm?.recordingApiKey"
                                    x-text="apiKeyCopied ? 'Copied!' : 'Copy'"></button>
                            <button class="btn" data-variant="secondary" data-size="test" type="button" tabindex="0"
                                    @click="regenerateApiKey()">Regenerate</button>
                        </div>
                    </div>
                </div>

                <!-- Notifications Panel - Notification configuration for silence events
                     Three notification methods (can use multiple):
                     - Webhook: HTTP POST to URL on silence start/end
                     - File Log: Append JSON lines to local file
                     - Email: SMTP notifications with configurable server -->
                <div class="panel" role="tabpanel" id="panel-notifications" aria-labelledby="tab-notifications" x-show="settingsTab === 'notifications'">
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.link"></span>
                            <h3>Webhook</h3>
                        </div>
                        <p class="section-desc">POST request sent when silence is detected.</p>
                        <div class="form">
                            <div class="group">
                                <label for="silence-webhook">Webhook URL</label>
                                <input id="silence-webhook" type="url" placeholder="https://hooks.example.com/..." x-model="settingsForm.silenceWebhook" @input="markSettingsDirty()">
                            </div>
                        </div>
                        <button class="btn" data-variant="secondary" data-size="test" type="button" tabindex="0" @click="sendTest('webhook')" :disabled="testStates.webhook.pending" x-text="testStates.webhook.text">Test</button>
                    </div>
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.email"></span>
                            <h3>Microsoft 365 Email</h3>
                        </div>
                        <p class="section-desc">Email notifications via Microsoft Graph API when silence is detected.</p>
                        <template x-if="graphSecretExpiry.expires_soon">
                            <div class="warning-banner">
                                <span x-html="icons.warning"></span>
                                <span>Client secret expires in <strong x-text="graphSecretExpiry.days_left"></strong> days. Regenerate in Azure Portal.</span>
                            </div>
                        </template>
                        <div class="form">
                            <div class="row">
                                <div class="group">
                                    <label for="graph-tenant-id">Tenant ID</label>
                                    <input id="graph-tenant-id" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" x-model="settingsForm.graph.tenantId" @input="markSettingsDirty()">
                                </div>
                                <div class="group">
                                    <label for="graph-client-id">Client ID</label>
                                    <input id="graph-client-id" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" x-model="settingsForm.graph.clientId" @input="markSettingsDirty()">
                                </div>
                            </div>
                            <div class="group">
                                <label for="graph-client-secret">Client Secret</label>
                                <input id="graph-client-secret" type="password" :placeholder="config.graph_has_secret ? '••••••••' : 'Azure AD client secret'" x-model="settingsForm.graph.clientSecret" @input="markSettingsDirty()" aria-describedby="graph-secret-hint">
                                <span id="graph-secret-hint" class="input-hint">Leave empty to keep existing secret</span>
                            </div>
                            <div class="group">
                                <label for="graph-from-address">From Address (Shared Mailbox)</label>
                                <input id="graph-from-address" type="email" placeholder="alerts@company.com" x-model="settingsForm.graph.fromAddress" @input="markSettingsDirty()" aria-describedby="graph-from-hint">
                                <span id="graph-from-hint" class="input-hint">Shared mailbox that will send the emails</span>
                            </div>
                            <div class="group">
                                <label for="graph-recipients">Recipients</label>
                                <input id="graph-recipients" type="text" placeholder="admin@company.com, tech@company.com" x-model="settingsForm.graph.recipients" @input="markSettingsDirty()" aria-describedby="graph-recipients-hint">
                                <span id="graph-recipients-hint" class="input-hint">Comma-separated email addresses.</span>
                            </div>
                        </div>
                        <button class="btn" data-variant="secondary" data-size="test" type="button" tabindex="0" @click="sendTest('email')" :disabled="testStates.email.pending" x-text="testStates.email.text">Test</button>
                    </div>
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.server"></span>
                            <h3>Zabbix</h3>
                        </div>
                        <p class="section-desc">Zabbix trapper items sent when silence is detected.</p>
                        <div class="form">
                            <div class="group">
                                <label for="zabbix-server">Server</label>
                                <input id="zabbix-server" type="text" placeholder="zabbix.example.com" x-model="settingsForm.zabbix.server" @input="markSettingsDirty()">
                            </div>
                            <div class="row">
                                <div class="group">
                                    <label for="zabbix-port">Port</label>
                                    <input id="zabbix-port" type="number" min="1" max="65535" placeholder="10051" x-model.number="settingsForm.zabbix.port" @input="markSettingsDirty()">
                                </div>
                                <div class="group">
                                    <label for="zabbix-host">Host</label>
                                    <input id="zabbix-host" type="text" placeholder="encoder-host" x-model="settingsForm.zabbix.host" @input="markSettingsDirty()">
                                </div>
                            </div>
                            <div class="group">
                                <label for="zabbix-key">Key</label>
                                <input id="zabbix-key" type="text" placeholder="silence.alert" x-model="settingsForm.zabbix.key" @input="markSettingsDirty()">
                            </div>
                        </div>
                        <button class="btn" data-variant="secondary" data-size="test" type="button" tabindex="0" @click="sendTest('zabbix')" :disabled="testStates.zabbix.pending" x-text="testStates.zabbix.text">Test</button>
                    </div>
                </div>

                <!-- Events Panel - Compact event log with stream identification -->
                <div class="panel" role="tabpanel" id="panel-events" aria-labelledby="tab-events" x-show="settingsTab === 'events'" x-init="$watch('settingsTab', val => val === 'events' && loadEvents())">
                    <div class="section">
                        <div class="event-toolbar">
                            <div class="event-filter-pills">
                                <button type="button" class="filter-pill" :class="{ active: eventFilter === '' }" @click="eventFilter = ''; loadEvents(true)">All</button>
                                <button type="button" class="filter-pill" :class="{ active: eventFilter === 'stream' }" @click="eventFilter = 'stream'; loadEvents(true)"><span class="filter-dot stream"></span>Streams</button>
                                <button type="button" class="filter-pill" :class="{ active: eventFilter === 'silence' }" @click="eventFilter = 'silence'; loadEvents(true)"><span class="filter-dot silence"></span>Audio</button>
                                <button type="button" class="filter-pill" :class="{ active: eventFilter === 'recorder' }" @click="eventFilter = 'recorder'; loadEvents(true)"><span class="filter-dot recorder"></span>Recorders</button>
                            </div>
                            <span class="event-count" x-show="events.length > 0" x-text="events.length + ' events'"></span>
                        </div>
                    </div>
                    <div class="section section--flush">
                        <div class="event-list" x-show="events.length > 0">
                            <template x-for="(event, index) in events" :key="index">
                                <article class="event-row" :data-severity="getEventSeverity(event.type)">
                                    <div class="event-time-col">
                                        <time class="event-time" :datetime="event.ts" :title="new Date(event.ts).toLocaleString('nl-NL')" x-text="formatEventTime(event.ts)"></time>
                                    </div>
                                    <div class="event-category-col">
                                        <span class="category-badge" :class="getEventCategory(event)" x-text="getEventCategoryBadge(event)"></span>
                                    </div>
                                    <div class="event-content-col">
                                        <div class="event-main">
                                            <span class="severity-dot" :class="getEventSeverity(event.type)"></span>
                                            <span class="event-source" x-text="getStreamBadgeText(event)"></span>
                                            <span class="event-action" x-text="getEventLabel(event.type)"></span>
                                        </div>
                                        <p class="event-detail" x-show="getEventDetail(event)" x-text="getEventDetail(event)"></p>
                                    </div>
                                </article>
                            </template>
                        </div>
                        <div class="event-empty" x-show="events.length === 0 && !eventsLoading">
                            <p>No events yet</p>
                        </div>
                        <div class="event-loading" x-show="eventsLoading">
                            <p>Loading...</p>
                        </div>
                        <button type="button" class="event-load-more" x-show="eventsHasMore && !eventsLoading" @click="loadMoreEvents()">Load older events</button>
                    </div>
                </div>

                <!-- About Panel - Version info and attribution
                     Shows: Version, commit hash, build date, update availability
                     Includes: MIT license text, audio plug logo SVG -->
                <div class="panel" role="tabpanel" id="panel-about" aria-labelledby="tab-about" x-show="settingsTab === 'about'">
                    <div class="about">
                        <div class="section">
                            <div class="logo">
                                <span x-html="icons.appLogo"></span>
                                <h2>{{.StationName}}</h2>
                            </div>
                            <div class="info">
                                <dl class="list">
                                    <dt>Version</dt>
                                    <dd id="about-version" x-text="`${version.current || 'dev'} (${(version.commit || 'unknown').slice(0, 7)})`">-</dd>
                                    <dt>Built</dt>
                                    <dd id="about-build" x-text="version.build_time || 'unknown'">-</dd>
                                    <dt>Platform</dt>
                                    <dd id="about-platform" x-text="config.platform || '-'">-</dd>
                                    <dt>Uptime</dt>
                                    <dd id="about-uptime" x-text="encoder.uptime || '-'">-</dd>
                                </dl>
                            </div>
                            <div class="links">
                                <a rel="noopener" href="https://github.com/oszuidwest/zwfm-encoder" title="View source code on GitHub" target="_blank">
                                    <span class="icon-container" x-html="icons.github"></span>
                                    GitHub
                                </a>
                                <a rel="noopener" href="https://github.com/oszuidwest/zwfm-encoder/issues" title="Report bugs or request features" target="_blank">
                                    <span class="icon-container" x-html="icons.bug"></span>
                                    Report Issue
                                </a>
                                <a rel="noopener" href="https://github.com/oszuidwest/zwfm-encoder/releases" title="View release history and downloads" target="_blank">
                                    <span class="icon-container" x-html="icons.download"></span>
                                    Releases
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.license"></span>
                            <h3>License</h3>
                        </div>
                        <div class="about">
                            <div class="text">
                                <p><strong>MIT License</strong></p>
                                <p>Copyright (c) {{.Year}} Streekomroep ZuidWest</p>
                                <p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
                                <p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
                                <p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
                            </div>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.heart"></span>
                            <h3>Acknowledgements</h3>
                        </div>
                        <p class="section-desc">This project is built with the following open source software:</p>
                        <div class="about">
                            <div class="text">
                                <p><a href="https://alpinejs.dev" target="_blank" rel="noopener" title="Visit Alpine.js website"><strong>Alpine.js</strong></a> — MIT License<br>Lightweight JavaScript framework for reactive UI</p>
                                <p><a href="https://heroicons.com" target="_blank" rel="noopener" title="Visit Heroicons website"><strong>Heroicons</strong></a> — MIT License<br>Beautiful hand-crafted SVG icons by Tailwind Labs</p>
                                <p><a href="https://ffmpeg.org" target="_blank" rel="noopener" title="Visit FFmpeg website"><strong>FFmpeg</strong></a> — LGPL/GPL License<br>Audio encoding and SRT streaming</p>
                                <p><a href="https://github.com/gorilla/websocket" target="_blank" rel="noopener" title="View Gorilla WebSocket on GitHub"><strong>Gorilla WebSocket</strong></a> — BSD License<br>WebSocket implementation for Go</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === Stream Form View ===
             Unified form for creating and editing streams.
             Mode detection: isEditMode checks if streamForm.id is set -->
        <div id="stream-form-view" class="settings" x-show="view === 'stream-form'" x-transition:enter.duration.200ms x-cloak>
            <header class="nav">
                <button class="nav-btn" type="button" tabindex="0" @click="showDashboard()">Cancel</button>
                <h2 x-text="isEditMode ? 'Edit Stream' : 'New Stream'">Stream</h2>
                <button class="nav-btn" data-variant="save" type="button" tabindex="0"
                        @click="submitStreamForm()"
                        :disabled="!streamForm.host || (isEditMode && !streamFormDirty)">Save</button>
            </header>

            <div class="panels">
                <div class="panel">
                    <!-- Server Connection Section -->
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.server"></span>
                            <h3>Server Connection</h3>
                        </div>
                        <p class="section-desc">Configure the SRT server to stream audio to.</p>
                        <div class="form">
                            <div class="group">
                                <label for="stream-host">Host</label>
                                <input id="stream-host" type="text" placeholder="stream.example.com"
                                       x-model="streamForm.host" @input="markStreamFormDirty()">
                            </div>
                            <div class="row">
                                <div class="group">
                                    <label for="stream-port">Port</label>
                                    <input id="stream-port" type="number"
                                           x-model.number="streamForm.port" @input="markStreamFormDirty()">
                                </div>
                                <div class="group">
                                    <label for="stream-streamid">Stream ID</label>
                                    <input id="stream-streamid" type="text" placeholder="studio"
                                           x-model="streamForm.stream_id" @input="markStreamFormDirty()">
                                </div>
                            </div>
                            <div class="group">
                                <label for="stream-password">Password</label>
                                <input id="stream-password" type="password"
                                       :placeholder="isEditMode ? 'Leave empty to keep' : 'Optional'"
                                       x-model="streamForm.password" @input="markStreamFormDirty()">
                            </div>
                        </div>
                    </div>

                    <!-- Encoding Section -->
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.settings"></span>
                            <h3>Encoding</h3>
                        </div>
                        <p class="section-desc">Audio encoding format and retry settings.</p>
                        <div class="form">
                            <div class="row">
                                <div class="group">
                                    <label for="stream-codec">Codec</label>
                                    <select id="stream-codec" x-model="streamForm.codec" @change="markStreamFormDirty()">
                                        <option value="mp3">MP3 (320 kbit/s)</option>
                                        <option value="mp2">MP2 (384 kbit/s)</option>
                                        <option value="ogg">Ogg Vorbis (~500 kbit/s)</option>
                                        <option value="wav">WAV (uncompressed)</option>
                                    </select>
                                </div>
                                <div class="group">
                                    <label for="stream-retries">Max Retries</label>
                                    <input id="stream-retries" type="number" max="9999" min="1"
                                           x-model.number="streamForm.max_retries" @input="markStreamFormDirty()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stream Status Section - Only in edit mode (yellow/warning) -->
                    <div class="section" data-variant="warning" x-show="isEditMode" x-cloak>
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.power"></span>
                            <h3>Stream Status</h3>
                        </div>
                        <p class="section-desc">Disabling stops the stream to this server. Changes apply on save.</p>
                        <div class="segmented" role="group" aria-label="Stream status">
                            <button type="button" class="segmented-btn"
                                    :aria-pressed="!streamForm.enabled"
                                    @click="streamForm.enabled = false; markStreamFormDirty()">
                                Disabled
                            </button>
                            <button type="button" class="segmented-btn"
                                    :aria-pressed="streamForm.enabled"
                                    @click="streamForm.enabled = true; markStreamFormDirty()">
                                Enabled
                            </button>
                        </div>
                    </div>

                    <!-- Danger Zone Section - Only in edit mode -->
                    <div class="section" data-variant="danger" x-show="isEditMode" x-cloak>
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.warning"></span>
                            <h3>Danger Zone</h3>
                        </div>
                        <p class="section-desc">Permanently delete this stream configuration.</p>
                        <button class="btn" data-variant="danger" data-block type="button" tabindex="0"
                                @click="deleteStream(streamForm.id, true)">
                            Delete Stream
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === Recorder Form View ===
             Unified form for creating and editing recorders.
             Mode detection: isRecorderEditMode checks if recorderForm.id is set -->
        <div id="recorder-form-view" class="settings" x-show="view === 'recorder-form'" x-transition:enter.duration.200ms x-cloak>
            <header class="nav">
                <button class="nav-btn" type="button" tabindex="0" @click="showDashboard()">Cancel</button>
                <h2 x-text="isRecorderEditMode ? 'Edit Recorder' : 'New Recorder'">Recorder</h2>
                <button class="nav-btn" data-variant="save" type="button" tabindex="0"
                        @click="submitRecorderForm()"
                        :disabled="!canSaveRecorder">Save</button>
            </header>

            <div class="panels">
                <div class="panel">
                    <!-- Recorder Info Section -->
                    <div class="section">
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.microphone"></span>
                            <h3>Recorder Info</h3>
                        </div>
                        <p class="section-desc">Configure the recorder name and behavior.</p>
                        <div class="form">
                            <div class="group">
                                <label for="recorder-name">Name</label>
                                <input id="recorder-name" type="text" placeholder="Main Archive"
                                       x-model="recorderForm.name" @input="markRecorderFormDirty()">
                            </div>
                            <div class="group">
                                <label for="recorder-rotation">Rotation Mode</label>
                                <select id="recorder-rotation" x-model="recorderForm.rotation_mode" @change="markRecorderFormDirty()" aria-describedby="recorder-rotation-hint">
                                    <option value="hourly">Hourly (auto-starts with encoder)</option>
                                    <option value="ondemand">On-Demand (API-controlled)</option>
                                </select>
                                <span id="recorder-rotation-hint" class="input-hint" x-show="recorderForm.rotation_mode === 'hourly'">Rotates at each hour boundary, starts automatically with encoder.</span>
                                <span class="input-hint" x-show="recorderForm.rotation_mode === 'ondemand'" aria-hidden="true">Start/stop via API calls. Stops at max duration (configured in settings).</span>
                            </div>
                            <div class="row">
                                <div class="group">
                                    <label for="recorder-codec">Codec</label>
                                    <select id="recorder-codec" x-model="recorderForm.codec" @change="markRecorderFormDirty()">
                                        <option value="mp3">MP3 (320 kbit/s)</option>
                                        <option value="mp2">MP2 (384 kbit/s)</option>
                                        <option value="ogg">Ogg Vorbis (~500 kbit/s)</option>
                                        <option value="wav">WAV (uncompressed)</option>
                                    </select>
                                </div>
                                <div class="group">
                                    <label for="recorder-storage">Storage</label>
                                    <select id="recorder-storage" x-model="recorderForm.storage_mode" @change="markRecorderFormDirty()">
                                        <option value="local">Local only</option>
                                        <option value="s3">S3 only</option>
                                        <option value="both">Local + S3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="group">
                                <label for="recorder-retention">Retention</label>
                                <div class="input-group">
                                    <input id="recorder-retention" type="number" min="0" max="365"
                                           x-model.number="recorderForm.retention_days"
                                           @input="markRecorderFormDirty()"
                                           aria-describedby="recorder-retention-hint">
                                    <span class="input-unit">days</span>
                                </div>
                                <span id="recorder-retention-hint" class="input-hint">Files older than this are automatically deleted. Set to 0 to keep forever.</span>
                            </div>
                        </div>
                    </div>

                    <!-- Local Storage Section -->
                    <div class="section" x-show="recorderForm.storage_mode !== 's3'" x-cloak>
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.folder"></span>
                            <h3>Local Storage</h3>
                        </div>
                        <p class="section-desc">Configure local directory for recordings.</p>
                        <div class="form">
                            <div class="group">
                                <label for="recorder-local-path">Local Path</label>
                                <input id="recorder-local-path" type="text" placeholder="/var/recordings/my-recorder"
                                       x-model="recorderForm.local_path"
                                       @input="markRecorderFormDirty()"
                                       aria-describedby="recorder-local-path-hint">
                                <span id="recorder-local-path-hint" class="input-hint">Ensure the service user has write permission to this directory.</span>
                            </div>
                        </div>
                    </div>

                    <!-- S3 Storage Section -->
                    <div class="section" x-show="recorderForm.storage_mode !== 'local'" x-cloak>
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.cloud"></span>
                            <h3>S3 Storage</h3>
                        </div>
                        <p class="section-desc">Configure S3-compatible storage for recordings.</p>
                        <div class="form">
                            <div class="group">
                                <label for="recorder-endpoint">S3 Endpoint</label>
                                <input id="recorder-endpoint" type="url" placeholder="https://s3.eu-west-1.amazonaws.com"
                                       x-model="recorderForm.s3_endpoint"
                                       @input="markRecorderFormDirty()"
                                       aria-describedby="recorder-endpoint-hint">
                                <span id="recorder-endpoint-hint" class="input-hint">Leave empty for AWS S3 default endpoint.</span>
                            </div>
                            <div class="group">
                                <label for="recorder-bucket">S3 Bucket</label>
                                <input id="recorder-bucket" type="text" placeholder="my-recordings"
                                       x-model="recorderForm.s3_bucket"
                                       @input="markRecorderFormDirty()">
                            </div>
                            <div class="group">
                                <label for="recorder-access-key">Access Key ID</label>
                                <input id="recorder-access-key" type="text" placeholder="AKIAIOSFODNN7EXAMPLE"
                                       x-model="recorderForm.s3_access_key_id"
                                       @input="markRecorderFormDirty()">
                            </div>
                            <div class="group">
                                <label for="recorder-secret-key">Secret Access Key</label>
                                <input id="recorder-secret-key" type="password"
                                       :placeholder="isRecorderEditMode ? 'Leave empty to keep' : 'Enter secret key'"
                                       x-model="recorderForm.s3_secret_access_key"
                                       @input="markRecorderFormDirty()">
                            </div>
                        </div>
                        <button class="btn" data-variant="secondary" data-size="test" type="button" tabindex="0"
                                @click="testRecorderS3()"
                                :disabled="testStates.recorderS3.pending || !recorderForm.s3_bucket"
                                x-text="testStates.recorderS3.text">Test Connection</button>
                    </div>

                    <!-- Status Section - Only in edit mode -->
                    <div class="section" data-variant="warning" x-show="isRecorderEditMode" x-cloak>
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.power"></span>
                            <h3>Recorder Status</h3>
                        </div>
                        <p class="section-desc">Control the recorder state. Changes apply on save.</p>
                        <div class="segmented" role="group" aria-label="Recorder status">
                            <button type="button" class="segmented-btn"
                                    :aria-pressed="!recorderForm.enabled"
                                    @click="recorderForm.enabled = false; markRecorderFormDirty()">
                                Disabled
                            </button>
                            <button type="button" class="segmented-btn"
                                    :aria-pressed="recorderForm.enabled"
                                    @click="recorderForm.enabled = true; markRecorderFormDirty()">
                                Enabled
                            </button>
                        </div>

                        <!-- Recording Controls - Only when on-demand mode -->
                        <template x-if="recorderForm.rotation_mode === 'ondemand'">
                            <div class="form" data-spaced>
                                <div class="group">
                                    <label>Recording Control</label>
                                    <template x-if="recorderStatuses[recorderForm.id]?.state === 'running'">
                                        <button class="btn" data-variant="danger" type="button" tabindex="0"
                                                @click="recorderAction(recorderForm.id, 'stop')">
                                            Stop Recording
                                        </button>
                                    </template>
                                    <template x-if="recorderStatuses[recorderForm.id]?.state !== 'running'">
                                        <button class="btn" data-variant="primary" type="button" tabindex="0"
                                                @click="recorderAction(recorderForm.id, 'start')"
                                                :disabled="!recorderForm.enabled">
                                            Start Recording
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Danger Zone Section - Only in edit mode -->
                    <div class="section" data-variant="danger" x-show="isRecorderEditMode" x-cloak>
                        <div class="section-header">
                            <span class="icon-container" x-html="icons.warning"></span>
                            <h3>Danger Zone</h3>
                        </div>
                        <p class="section-desc">Permanently delete this recorder configuration.</p>
                        <button class="btn" data-variant="danger" data-block type="button" tabindex="0"
                                @click="deleteRecorder(recorderForm.id, true)">
                            Delete Recorder
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="links">
                <a rel="noopener" href="https://github.com/oszuidwest/zwfm-encoder" title="View source on GitHub" target="_blank">
                    <span class="icon-container" x-html="icons.github"></span>
                    GitHub
                </a>
                <span class="sep">|</span>
                <span>Version <span class="version">{{.Version}}</span></span>
            </div>
            <div class="copyright">© {{.Year}} Streekomroep ZuidWest • MIT License</div>
        </footer>
    </main>

    <script src="/icons.js"></script>
    <script src="/app.js"></script>
</body>
</html>
